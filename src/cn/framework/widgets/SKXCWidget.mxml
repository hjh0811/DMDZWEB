<?xml version="1.0" encoding="utf-8"?>
<framework:BaseWidget xmlns:fx="http://ns.adobe.com/mxml/2009" xmlns:framework="cn.framework.*"
					  xmlns:s="library://ns.adobe.com/flex/spark" fontSize="12" fontFamily="宋体" creationComplete="init()"
					  xmlns:mx="library://ns.adobe.com/flex/mx"  width="100%" height="100%" xmlns:UserManager="cn.framework.widgets.UserManager.*" xmlns:components="cn.framework.components.*">
	
	<fx:Script>
		<![CDATA[
			import cn.framework.FrameContainer;
			
			import mx.core.FlexGlobals;
			
			import cn.framework.widgets.UserManager.FormList;
			
			import com.esri.ags.Graphic;
			import com.esri.ags.geometry.MapPoint;
			import com.esri.ags.layers.GraphicsLayer;
			import com.esri.ags.symbols.PictureMarkerSymbol;
			
			import mx.collections.ArrayCollection;
			import mx.events.IndexChangedEvent;
			import mx.rpc.events.ResultEvent;
			import mx.rpc.http.HTTPService;
			private var graphicsLayer:GraphicsLayer = new GraphicsLayer;

			
			[Bindable]
			private var recAC:ArrayCollection = null;
		
			protected function init():void
			{
				this.moduleFactory=FlexGlobals.topLevelApplication.moduleFactory;	
				// TODO Auto-generated method stub
				var httpservice:HTTPService = new HTTPService;
				httpservice.url = "cn/framework/widgets/SKXCWidget.xml";
				httpservice.resultFormat = "e4x";
				httpservice.method = "GET";
				httpservice.addEventListener(ResultEvent.RESULT, configHandler);
				httpservice.send();
				
				this.map.addLayer(graphicsLayer);
				FrameContainer.getInstance().serviceManager.getDataByService({t:"SK_XC1"},dataSKHandler,"POST");
			}
			
			[Bindable]
			private var treeXml:XML;
			private function configHandler(event:ResultEvent):void
			{
				var xml:XML = event.result as XML;
				treeXml = XML(xml.tree);
			}
			
			private var formlist:FormList;
			protected function tabnavigatorchangeHandler(event:IndexChangedEvent):void
			{
				if(formlist==null)
				{
					formlist = new FormList;
					this.borderContainer.addElement(formlist);
					formlist.configXML = treeXml.node[0];
				}
			}
			
			private function dataSKHandler(event:ResultEvent):void
			{
				if(event.result==null || event.result=="") return; 
				var jsonObject:Object = JSON.parse(event.result.toString()) as Object; 
				if(jsonObject==null || jsonObject["values"] == null) return; 	
				this.recAC = new ArrayCollection;
				var jsonValues:Array = jsonObject["values"] as Array;
				
				if(jsonValues!=null && jsonValues.length > 0)
				{
					var count:int = jsonValues.length;
					for each(var obj:Object in jsonValues)
					{
						var graphic:Graphic = new Graphic;
						var pt:MapPoint = new MapPoint(obj["x"],obj["y"]);
						graphic.geometry = pt;
						graphic.symbol = new PictureMarkerSymbol("assets/images/i_edit.png",40, 40);
						
						var infoData:Object={
							icon: "assets/images/i_edit.png",title: obj["name"], //标题
								content:obj["sbsj"], //字段内容
								point: pt, //位置点
								geometry:graphic,attributes:obj
						};
						graphic.attributes = infoData;
						graphicsLayer.add(graphic);
						this.recAC.addItem(infoData);
					}
				}
			}


			private function clickRecord(event:MouseEvent):void
			{
				var infoData:Object=event.currentTarget.infoData;
				var pt:MapPoint=infoData.point;
				var gra:Graphic=infoData.geometry as Graphic;
				
				if(pt==null) return;
				
				this.map.infoWindow.label = " " + infoData.title;
				this.map.infoWindow.content= null;
				this.map.infoWindow.show(pt);
				this.map.centerAt(pt);
				this.map.level=5;
			}

		]]>
	</fx:Script>
	<mx:TabNavigator width="100%" height="100%" change="tabnavigatorchangeHandler(event)">
		<s:NavigatorContent label="巡查记录查询"  width="100%" height="100%">
			<s:BorderContainer width="100%" height="100%" borderVisible="false">
				<s:layout>
					<s:VerticalLayout/>
				</s:layout>
				<s:HGroup verticalAlign="middle" paddingLeft="10">
					<s:Label text="时间:"/>
					<mx:DateField width="100" yearNavigationEnabled="true" formatString="YYYY-MM-DD"/>
					<s:Label text="至"/>
					<mx:DateField width="100" yearNavigationEnabled="true" formatString="YYYY-MM-DD"/>
				</s:HGroup>
				<s:HGroup verticalAlign="middle" paddingLeft="10">
					<s:Label text="水库:"/>
					<s:ComboBox width="100%">
						<s:dataProvider>
							<s:ArrayList>
								<fx:String>宝江水库</fx:String>
								<fx:String>罗田水库</fx:String>
								<fx:String>孔江水库</fx:String>
								<fx:String>围背水库</fx:String>
							</s:ArrayList>
						</s:dataProvider>
					</s:ComboBox>
				</s:HGroup>
				<s:HGroup verticalAlign="middle" paddingLeft="10">
					<s:Label text="人员:"/><s:ComboBox width="100%">
											 <s:dataProvider>
												 <s:ArrayList>
													 <fx:String>巡查员1</fx:String>
													 <fx:String>巡查员2</fx:String>
													 <fx:String>巡查员3</fx:String>
												 </s:ArrayList>
											 </s:dataProvider>
										 </s:ComboBox>
				</s:HGroup>
				<mx:VBox width="100%" height="100%">
					<mx:Repeater id="reReater" dataProvider="{this.recAC}" width="100%" height="100%" count="10">
						<components:XCRepeater infoData="{reReater.currentItem}" click="clickRecord(event)"/>
					</mx:Repeater>
				</mx:VBox>
			</s:BorderContainer>	
		</s:NavigatorContent>
		<s:NavigatorContent label="巡查记录录入"  width="100%" height="100%">
			<s:VGroup  width="100%" height="100%">
				<s:BorderContainer id="borderContainer" width="100%" height="100%" borderStyle="solid" borderVisible="false">
					<s:backgroundFill>
						<s:SolidColor 
							alpha="0"/> 
					</s:backgroundFill>
				</s:BorderContainer>
			</s:VGroup>
		</s:NavigatorContent>
	</mx:TabNavigator>
</framework:BaseWidget>
